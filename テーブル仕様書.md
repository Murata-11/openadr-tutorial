# テーブル仕様書

## VTN 配信用キュー（vtnDeliveryQueue）

| 属性名      | 説明                           | 備考                               |
| ----------- | ------------------------------ | ---------------------------------- |
| pk          | パーティションキー             |                                    |
| enqueueTs   | ソートキー                     | `2025-01-01T00:00:00Z`             |
| messageType |                                | 例: `oadrDistributeEvent`          |
| state       |                                | 例: `PENDING`                      |
| skGsi       | GSI ソートキー                 | 例: `PENDING#2025-01-01T00:00:00Z` |
| updatedAt   |                                |                                    |
| payload     | 各メッセージタイプのペイロード |                                    |

## 例: メッセージタイプが`oadrDistributeEvent`の場合

```json
{
  "pk": "ven-001#DISTRIBUTEEVENT",
  "enqueueTs": "2025-01-01T00:00:00Z",
  "sk_gsi": "PENDING#2025-01-01T00:00:00Z",
  "state": "PENDING",
  "message_type": "oadrCreateReport",
  "updatedAt": "2025-01-01T00:00:00Z",
  "payload": {
    "events": [
      {
        "event_descriptor": {
          "event_id": "evt-20250904-001",
          "modification_number": 0,
          "event_status": "far",
          "market_context": "oadr://program/default",
          "created_date_time_iso": "2025-09-04T01:00:00Z"
        },
        "event_signals": [
          {
            "signal_id": "sig-1",
            "signal_name": "simple",
            "signal_type": "level",
            "intervals": [
              {
                "dtstart_iso": "2025-09-04T01:05:00Z",
                "duration_seconds": 900,
                "signal_payload": 1
              },
              {
                "dtstart_iso": "2025-09-04T01:20:00Z",
                "duration_seconds": 600,
                "signal_payload": 0
              }
            ]
          }
        ],
        "targets": [{ "ven_id": "ven-001" }]
      }
    ]
  }
}
```

## 例: メッセージタイプが`oadrCreateReport`の場合

```json
{
  "ven_id": "ven-001#CREATEREPORT",
  "enqueueTs": "2025-01-01T00:00:00Z",
  "sk_gsi": "PENDING#2025-01-01T00:00:00Z",
  "state": "PENDING",
  "message_type": "oadrCreateReport",
  "updatedAt": "2025-01-01T00:00:00Z",
  "payload": {
    "ven_id": "ven-001",
    "report_requests": [
      {
        "report_request_id": "rrid-20250904-01",
        "report_specifier": {
          "report_specifier_id": "TelemetryStatus",
          "granularity_seconds": 300,
          "report_back_duration_seconds": 3600,
          "specifier_payloads": [{ "r_id": "r001" }, { "r_id": "r002" }]
        },
        "report_interval": {
          "dtstart_iso": "2025-09-04T01:00:00Z",
          "duration_seconds": 86400
        }
      }
    ]
  }
}
```

## 例: メッセージタイプが`oadrCancelReport`の場合

```json
{
  "ven_id": "ven-001#CANCELREPORT",
  "enqueueTs": "2025-01-01T00:00:00Z",
  "sk_gsi": "PENDING#2025-01-01T00:00:00Z",
  "state": "PENDING",
  "message_type": "oadrCreateReport",
  "updatedAt": "2025-01-01T00:00:00Z",
  "payload": {
    "ven_id": "ven-001",
    "report_request_id": "rrid-20250904-01",
    "report_to_follow": false
  }
}
```

## on_poll 実装例

```python
async def pop_next_message(ven_id: str):
    async with aioboto3.resource("dynamodb") as dynamodb:
        table = await dynamodb.Table(DDB_TABLE)

        # 1) 取り出し候補を検索（state=PENDING, not_before<=now）
        now = int(time.time())
        resp = await table.query(
            IndexName="gsi_ven_state",  # PK=ven_id, SK=state#priority#enqueue_ts
            KeyConditionExpression=Key("ven_id").eq(ven_id)
                                   & Key("sk_gsi").begins_with("PENDING#"),
            FilterExpression=Attr("not_before").lte(now),
            Limit=1,
            ScanIndexForward=True
        )
        if not resp.get("Items"):
            return None

        item = resp["Items"][0]
        lease = str(uuid.uuid4())

        # 2) LOCK に遷移（条件付き）
        upd = await table.update_item(
            Key={"ven_id": item["ven_id"], "sort_key": item["sort_key"]},
            ConditionExpression=Attr("state").eq("PENDING"),
            UpdateExpression="SET #s=:locked, lock_until=:lu, lease=:lease, attempts=if_not_exists(attempts, :z)+:one",
            ExpressionAttributeNames={"#s": "state"},
            ExpressionAttributeValues={":locked": "LOCKED", ":lu": now+VISIBILITY, ":lease": lease, ":z": 0, ":one": 1},
            ReturnValues="ALL_NEW"
        )
        locked = upd["Attributes"]
        return locked["message_type"], locked["payload"], locked  # locked は後続更新用

async def on_poll(ven_id: str):
    msg = await pop_next_message(ven_id)
    if not msg:
        return None
    message_type, payload, locked_item = msg
    return message_type, payload
```
